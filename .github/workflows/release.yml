name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_ID: com.aura.dev

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

  build:
    needs: extract-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            channel: osx-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            channel: win-x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            channel: linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build frontend
        run: pnpm build

      - name: Build Tauri app
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: src-tauri

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Install vpk CLI
        run: dotnet tool install -g vpk

      - name: Download existing releases
        run: vpk download github --repoUrl https://github.com/${{ github.repository }} --token ${{ secrets.GITHUB_TOKEN }} --channel ${{ matrix.channel }} || true

      - name: Package with Velopack (macOS)
        if: runner.os == 'macOS'
        run: |
          vpk pack \
            -u ${{ env.APP_ID }} \
            -v ${{ needs.extract-version.outputs.version }} \
            -p src-tauri/target/${{ matrix.target }}/release \
            -e aura-app \
            --channel ${{ matrix.channel }}

      - name: Package with Velopack (Linux)
        if: runner.os == 'Linux'
        run: |
          vpk pack \
            -u ${{ env.APP_ID }} \
            -v ${{ needs.extract-version.outputs.version }} \
            -p src-tauri/target/${{ matrix.target }}/release \
            -e aura-app \
            --channel ${{ matrix.channel }}

      - name: Package with Velopack (Windows)
        if: runner.os == 'Windows'
        run: |
          vpk pack `
            -u ${{ env.APP_ID }} `
            -v ${{ needs.extract-version.outputs.version }} `
            -p src-tauri\target\${{ matrix.target }}\release `
            -e aura-app.exe `
            --channel ${{ matrix.channel }}

      - name: Upload to GitHub Releases
        run: |
          vpk upload github \
            --repoUrl https://github.com/${{ github.repository }} \
            --tag ${{ github.ref_name }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --releaseName "Aura ${{ needs.extract-version.outputs.version }}" \
            --merge \
            --channel ${{ matrix.channel }}
        shell: bash
